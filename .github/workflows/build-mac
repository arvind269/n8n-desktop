name: Build macOS n8n Desktop (Universal Portable)

on:
  workflow_dispatch: # Run manually from GitHub Actions tab

jobs:
  build:
    runs-on: macos-latest

    env:
      ELECTRON_BUILDER_ALLOW_UNRESOLVED_DEPENDENCIES: true

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Extract source
        run: unzip "${{ github.workspace }}/n8n-desktop.zip" -d ./src

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install distutils for Python
        run: |
          python3 -m ensurepip --upgrade
          python3 -m pip install setuptools

      - name: Install dependencies
        run: |
          cd src/n8n-desktop
          npm install

      - name: Rebuild native modules
        run: |
          cd src/n8n-desktop
          npm run rebuild-native-module

      - name: Build macOS universal portable app
        run: |
          cd src/n8n-desktop
          npm run build-mac-no-sign

      - name: Upload portable macOS universal app
        uses: actions/upload-artifact@v4
        with:
          name: n8n-macos-universal-portable
          path: src/n8n-desktop/dist/mac/n8n.app
